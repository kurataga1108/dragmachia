<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒ©ã‚°ãƒã‚­ã‚¢ - ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #222; color: #fff; margin: 0; padding: 20px; }
        .battle-area { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .character { background: #333; padding: 15px; border-radius: 8px; width: 40%; position: relative; }
        .hp-bar { background: #555; height: 20px; border-radius: 10px; margin-top: 5px; overflow: hidden;}
        .hp-fill { background: #4caf50; height: 100%; width: 100%; transition: width 0.3s; }
        .enemy-hp .hp-fill { background: #f44336; }
        
        /* çŠ¶æ…‹ç•°å¸¸ã®ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ */
        .status-box { height: 20px; font-size: 14px; margin-top: 5px; font-weight: bold; }
        .status-poison { color: #e040fb; text-shadow: 0 0 5px #000; margin-right: 5px; }
        .status-para { color: #ffeb3b; text-shadow: 0 0 5px #000; }
        
        .command-area { display: flex; flex-direction: column; gap: 10px; align-items: center; }
        button { padding: 12px 20px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; background: #2196f3; color: white; cursor: pointer; width: 100%; max-width: 300px; transition: 0.2s;}
        button:active { background: #1976d2; transform: scale(0.98); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; transform: none; }
        
        #log { margin-top: 20px; height: 150px; overflow-y: scroll; background: #111; padding: 10px; border-radius: 8px; text-align: left; font-size: 14px; line-height: 1.5;}
        .crit-text { color: #ffeb3b; font-weight: bold; }
        .miss-text { color: #9e9e9e; font-style: italic; }
        .poison-text { color: #e040fb; }
        .para-text { color: #ffeb3b; }
    </style>
</head>
<body>

    <h1>ãƒ‰ãƒ©ã‚°ãƒã‚­ã‚¢</h1>

    <div class="battle-area">
        <div class="character">
            <h3>ãƒªãƒ¼ãƒ•ãƒ­ãƒ³ã‚°</h3>
            <div id="player-hp-text">HP: 45 / 45</div>
            <div class="hp-bar"><div id="player-hp-fill" class="hp-fill"></div></div>
            <div id="player-status" class="status-box"></div>
        </div>
        <div class="character">
            <h3>ãƒ—ãƒãƒ•ãƒ¬ã‚¢</h3>
            <div id="enemy-hp-text">HP: 30 / 30</div>
            <div class="hp-bar enemy-hp"><div id="enemy-hp-fill" class="hp-fill"></div></div>
            <div id="enemy-status" class="status-box"></div>
        </div>
    </div>

    <div class="command-area">
        <button id="btn-skill-0" onclick="startTurn(0)">ãŸã„ã‚ãŸã‚Š</button>
        <button id="btn-skill-1" onclick="startTurn(1)">ãƒã‚¤ã‚ºãƒ³ãƒ–ãƒ¬ã‚¹</button>
        <button id="btn-skill-2" onclick="startTurn(2)">ãƒ‘ãƒ©ãƒ©ã‚¤ã‚ºãƒ­ã‚¢</button>
    </div>

    <div id="log">é‡ç”Ÿã®ãƒ—ãƒãƒ•ãƒ¬ã‚¢ãŒç¾ã‚ŒãŸï¼<br>ãƒãƒˆãƒ«é–‹å§‹ï¼<br></div>

    <script>
        // 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã€ŒçŠ¶æ…‹ç•°å¸¸(status)ã€ã¨ã€Œè€æ€§(resist)ã€ã‚’è¿½åŠ 
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æœ¨å±æ€§ã®ã€Œãƒªãƒ¼ãƒ•ãƒ­ãƒ³ã‚°ã€ã«å¤‰æ›´ï¼ˆé«˜HPãƒ»ä½é€Ÿåº¦ãƒ»çŠ¶æ…‹ç•°å¸¸æŠ€æŒã¡ï¼‰
        let player = { 
            name: "ãƒªãƒ¼ãƒ•ãƒ­ãƒ³ã‚°", maxHp: 45, hp: 45, atk: 10, def: 15, spd: 8, crit: 0.05, eva: 0.0,
            status: { poison: 0, paralysis: 0 }, resist: { poison: 0.0, paralysis: 0.0 },
            skills: [
                { name: "ãŸã„ã‚ãŸã‚Š", power: 1.0, maxCt: 0, currentCt: 0, accuracy: 1.0, effect: null, effectChance: 0 },
                { name: "ãƒã‚¤ã‚ºãƒ³ãƒ–ãƒ¬ã‚¹", power: 0.5, maxCt: 3, currentCt: 0, accuracy: 0.9, effect: "poison", effectChance: 0.7 }, // 70%ã§æ¯’(3ã‚¿ãƒ¼ãƒ³)
                { name: "ãƒ‘ãƒ©ãƒ©ã‚¤ã‚ºãƒ­ã‚¢", power: 0.8, maxCt: 4, currentCt: 0, accuracy: 0.9, effect: "paralysis", effectChance: 0.6 } // 60%ã§éº»ç—º(2ã‚¿ãƒ¼ãƒ³)
            ]
        };
        // æ•µã®é€Ÿåº¦ã¯10ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®8ã‚ˆã‚Šé€Ÿã„ã®ã§ã€å¿…ãšæ•µãŒå…ˆåˆ¶ã—ã¾ã™ï¼‰
        let enemy = { 
            name: "ãƒ—ãƒãƒ•ãƒ¬ã‚¢", maxHp: 30, hp: 30, atk: 12, def: 8, spd: 10, crit: 0.05, eva: 0.1,
            status: { poison: 0, paralysis: 0 }, resist: { poison: 0.0, paralysis: 0.0 },
            skills: [ { name: "ä½“å½“ãŸã‚Š", power: 1.0, maxCt: 0, currentCt: 0, accuracy: 1.0, effect: null, effectChance: 0 } ]
        };

        function addLog(message) {
            const logDiv = document.getElementById("log");
            logDiv.innerHTML += message + "<br>";
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // çŠ¶æ…‹ç•°å¸¸ã®è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œã‚‹
        function getStatusHtml(char) {
            let html = "";
            if (char.status.poison > 0) html += `<span class="status-poison">ã€æ¯’ã€‘</span>`;
            if (char.status.paralysis > 0) html += `<span class="status-para">ã€éº»ç—ºã€‘</span>`;
            return html;
        }

        function updateUI() {
            document.getElementById("player-hp-text").innerText = `HP: ${player.hp} / ${player.maxHp}`;
            document.getElementById("player-hp-fill").style.width = `${(player.hp / player.maxHp) * 100}%`;
            document.getElementById("player-status").innerHTML = getStatusHtml(player);
            
            document.getElementById("enemy-hp-text").innerText = `HP: ${enemy.hp} / ${enemy.maxHp}`;
            document.getElementById("enemy-hp-fill").style.width = `${(enemy.hp / enemy.maxHp) * 100}%`;
            document.getElementById("enemy-status").innerHTML = getStatusHtml(enemy);

            for(let i = 0; i < 3; i++) {
                let btn = document.getElementById(`btn-skill-${i}`);
                let skill = player.skills[i];
                if(skill.currentCt > 0) {
                    btn.innerText = `${skill.name} (ã‚ã¨${skill.currentCt}ã‚¿ãƒ¼ãƒ³)`;
                    btn.disabled = true;
                } else {
                    btn.innerText = skill.name;
                    if(player.hp > 0 && enemy.hp > 0) btn.disabled = false;
                }
            }
        }

        function disableAllButtons() {
            for(let i = 0; i < 3; i++) {
                document.getElementById(`btn-skill-${i}`).disabled = true;
            }
        }

        // 2. æ”»æ’ƒã¨çŠ¶æ…‹ç•°å¸¸ã®åˆ¤å®š
        function performAttack(attacker, defender, skill) {
            let result = { damage: 0, isMiss: true, isCrit: false, addedStatus: null };
            
            let hitChance = skill.accuracy - defender.eva;
            if (Math.random() > hitChance) return result;

            result.isMiss = false;

            // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
            let baseDamage = attacker.atk - (defender.def / 2);
            let randomFactor = (Math.random() * 0.3) + 0.85; 
            let finalDamage = Math.floor(baseDamage * randomFactor * skill.power);
            result.damage = Math.max(1, finalDamage);

            if (Math.random() < attacker.crit) {
                result.isCrit = true;
                result.damage = Math.floor(result.damage * 1.5);
            }

            // çŠ¶æ…‹ç•°å¸¸ã®ä»˜ä¸åˆ¤å®š
            if (skill.effect) {
                let statusChance = skill.effectChance - defender.resist[skill.effect];
                if (Math.random() < statusChance) {
                    defender.status[skill.effect] = (skill.effect === "poison") ? 3 : 2; // æ¯’ã¯3ã‚¿ãƒ¼ãƒ³ã€éº»ç—ºã¯2ã‚¿ãƒ¼ãƒ³
                    result.addedStatus = skill.effect;
                }
            }

            return result;
        }

        // 3. ã‚¿ãƒ¼ãƒ³ã®é€²è¡Œ
        function startTurn(skillIndex) {
            if (player.hp <= 0 || enemy.hp <= 0) return;
            disableAllButtons();

            let pSkill = player.skills[skillIndex];
            pSkill.currentCt = pSkill.maxCt;

            let actions = [
                { actor: player, target: enemy, skill: pSkill },
                { actor: enemy, target: player, skill: enemy.skills[0] }
            ];

            // é€Ÿåº¦é †ã«ä¸¦ã³æ›¿ãˆï¼ˆãƒªãƒ¼ãƒ•ãƒ­ãƒ³ã‚°ã¯é…ã„ã®ã§å¾Œæ”»ã«ãªã‚Šã¾ã™ï¼‰
            actions.sort((a, b) => {
                if (a.actor.spd === b.actor.spd) return Math.random() - 0.5;
                return b.actor.spd - a.actor.spd;
            });

            function processAction(index) {
                if (index >= actions.length || player.hp <= 0 || enemy.hp <= 0) {
                    endTurn();
                    return;
                }

                let act = actions[index];
                let icon = act.actor === player ? "â–¶" : "â–·";
                let actionDelay = 800;

                // â‘  éº»ç—ºã®ãƒã‚§ãƒƒã‚¯ï¼ˆè¡Œå‹•å‰ã«åˆ¤å®šï¼‰
                if (act.actor.status.paralysis > 0) {
                    act.actor.status.paralysis--; // ã‚¿ãƒ¼ãƒ³ã‚’æ¶ˆè²»
                    if (Math.random() < 0.5) {
                        addLog(`${icon} ${act.actor.name}ã¯<span class="para-text">ä½“ãŒã—ã³ã‚Œã¦å‹•ã‘ãªã„ï¼</span>`);
                        updateUI();
                        checkPoison(act.actor, icon); // å‹•ã‘ãªãã¦ã‚‚æ¯’ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯å—ã‘ã‚‹
                        setTimeout(() => processAction(index + 1), actionDelay);
                        return;
                    }
                }

                // â‘¡ æ”»æ’ƒã®å®Ÿè¡Œ
                let result = performAttack(act.actor, act.target, act.skill);
                
                if (result.isMiss) {
                    addLog(`${icon} ${act.actor.name}ã® ${act.skill.name}ï¼ <span class="miss-text">...ã—ã‹ã—é¿ã‘ã‚‰ã‚ŒãŸï¼ï¼ˆãƒŸã‚¹ï¼‰</span>`);
                } else {
                    act.target.hp = Math.max(0, act.target.hp - result.damage);
                    let critText = result.isCrit ? `<span class="crit-text">ä¼šå¿ƒã®ä¸€æ’ƒï¼ï¼</span> ` : "";
                    addLog(`${icon} ${act.actor.name}ã® ${act.skill.name}ï¼ ${critText}${act.target.name}ã« ${result.damage} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
                    
                    // çŠ¶æ…‹ç•°å¸¸ãŒä»˜ä¸ã•ã‚ŒãŸæ™‚ã®ãƒ­ã‚°
                    if (result.addedStatus === "poison") {
                        addLog(`â˜ï¸ ${act.target.name}ã¯<span class="poison-text">æ¯’</span>ã‚’æµ´ã³ãŸï¼`);
                    } else if (result.addedStatus === "paralysis") {
                        addLog(`âš¡ ${act.target.name}ã¯<span class="para-text">éº»ç—º</span>ã—ã¦ã—ã¾ã£ãŸï¼`);
                    }
                }

                updateUI();

                // æ•µã‚’å€’ã—ãŸã‹åˆ¤å®š
                if (enemy.hp <= 0) {
                    addLog(`â­ ${enemy.name}ã®æ´—è„³ãŒè§£ã‘ã€ä»²é–“ã«åŠ ã‚ã£ãŸï¼`);
                    return;
                }

                // â‘¢ æ¯’ã®ãƒã‚§ãƒƒã‚¯ï¼ˆè¡Œå‹•å¾Œã«åˆ¤å®šï¼‰
                checkPoison(act.actor, icon);

                if (player.hp <= 0) {
                    addLog(`ğŸ’€ ${player.name}ã¯å€’ã‚ŒãŸ...ç›®ã®å‰ãŒçœŸã£æš—ã«ãªã£ãŸã€‚`);
                    return;
                }

                setTimeout(() => {
                    processAction(index + 1);
                }, actionDelay);
            }

            processAction(0);
        }

        // æ¯’ã®ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†
        function checkPoison(char, icon) {
            if (char.status.poison > 0) {
                char.status.poison--;
                let poisonDamage = Math.max(1, Math.floor(char.maxHp * 0.1)); // æœ€å¤§HPã®10%ï¼ˆæœ€ä½1ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰
                char.hp = Math.max(0, char.hp - poisonDamage);
                addLog(`${icon} ${char.name}ã¯<span class="poison-text">æ¯’ã®ãƒ€ãƒ¡ãƒ¼ã‚¸</span>ã‚’å—ã‘ãŸï¼ï¼ˆ${poisonDamage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰`);
                updateUI();
            }
        }

        function endTurn() {
            for(let i=0; i<3; i++) {
                if(player.skills[i].currentCt > 0) player.skills[i].currentCt--;
            }
            setTimeout(() => {
                updateUI();
            }, 500);
        }
    </script>
</body>
</html>
