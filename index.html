<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒ©ã‚°ãƒã‚­ã‚¢ - ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #222; color: #fff; margin: 0; padding: 20px; }
        .battle-area { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .character { background: #333; padding: 15px; border-radius: 8px; width: 40%; }
        .hp-bar { background: #555; height: 20px; border-radius: 10px; margin-top: 10px; overflow: hidden;}
        .hp-fill { background: #4caf50; height: 100%; width: 100%; transition: width 0.3s; }
        .enemy-hp .hp-fill { background: #f44336; }
        
        .command-area { display: flex; flex-direction: column; gap: 10px; align-items: center; }
        button { padding: 12px 20px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; background: #2196f3; color: white; cursor: pointer; width: 100%; max-width: 300px; transition: 0.2s;}
        button:active { background: #1976d2; transform: scale(0.98); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; transform: none; }
        
        #log { margin-top: 20px; height: 150px; overflow-y: scroll; background: #111; padding: 10px; border-radius: 8px; text-align: left; font-size: 14px; line-height: 1.5;}
        /* ãƒ­ã‚°ã®è‰²åˆ†ã‘ç”¨ã‚¯ãƒ©ã‚¹ */
        .crit-text { color: #ffeb3b; font-weight: bold; }
        .miss-text { color: #9e9e9e; font-style: italic; }
    </style>
</head>
<body>

    <h1>ãƒ‰ãƒ©ã‚°ãƒã‚­ã‚¢</h1>

    <div class="battle-area">
        <div class="character">
            <h3>ãƒ¬ãƒƒãƒ‰ã‚¦ã‚£ãƒ³ã‚°</h3>
            <div id="player-hp-text">HP: 35 / 35</div>
            <div class="hp-bar"><div id="player-hp-fill" class="hp-fill"></div></div>
        </div>
        <div class="character">
            <h3>ãƒ—ãƒãƒ•ãƒ¬ã‚¢</h3>
            <div id="enemy-hp-text">HP: 30 / 30</div>
            <div class="hp-bar enemy-hp"><div id="enemy-hp-fill" class="hp-fill"></div></div>
        </div>
    </div>

    <div class="command-area">
        <button id="btn-skill-0" onclick="executeTurn(0)">ã²ã£ã‹ã</button>
        <button id="btn-skill-1" onclick="executeTurn(1)">ãƒ•ãƒ¬ã‚¤ãƒ ãƒ–ãƒ¬ã‚¹</button>
        <button id="btn-skill-2" onclick="executeTurn(2)">æ¸¾èº«ã®ä¸€æ’ƒ</button>
    </div>

    <div id="log">é‡ç”Ÿã®ãƒ—ãƒãƒ•ãƒ¬ã‚¢ãŒç¾ã‚ŒãŸï¼<br>ãƒãƒˆãƒ«é–‹å§‹ï¼<br></div>

    <script>
        // 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã€Œã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡(crit)ã€ã€Œå›é¿ç‡(eva)ã€ã€ŒæŠ€ã®å‘½ä¸­ç‡(accuracy)ã€ã‚’è¿½åŠ 
        let player = { 
            name: "ãƒ¬ãƒƒãƒ‰ã‚¦ã‚£ãƒ³ã‚°", maxHp: 35, hp: 35, atk: 18, def: 10, crit: 0.05, eva: 0.0,
            skills: [
                { name: "ã²ã£ã‹ã", power: 1.0, maxCt: 0, currentCt: 0, accuracy: 1.0 },       // å‘½ä¸­100%
                { name: "ãƒ•ãƒ¬ã‚¤ãƒ ãƒ–ãƒ¬ã‚¹", power: 1.5, maxCt: 3, currentCt: 0, accuracy: 0.9 }, // å‘½ä¸­90%
                { name: "æ¸¾èº«ã®ä¸€æ’ƒ", power: 2.0, maxCt: 4, currentCt: 0, accuracy: 0.8 }  // å‘½ä¸­80%
            ]
        };
        // æ•µã¯10%ã®ç¢ºç‡ã§æ”»æ’ƒã‚’é¿ã‘ã‚‹ç´ æ—©ã„è¨­å®š
        let enemy = { name: "ãƒ—ãƒãƒ•ãƒ¬ã‚¢", maxHp: 30, hp: 30, atk: 12, def: 8, crit: 0.05, eva: 0.1,
            skills: [ { name: "ä½“å½“ãŸã‚Š", power: 1.0, maxCt: 0, currentCt: 0, accuracy: 1.0 } ]
        };

        function addLog(message) {
            const logDiv = document.getElementById("log");
            logDiv.innerHTML += message + "<br>";
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateUI() {
            document.getElementById("player-hp-text").innerText = `HP: ${player.hp} / ${player.maxHp}`;
            document.getElementById("player-hp-fill").style.width = `${(player.hp / player.maxHp) * 100}%`;
            
            document.getElementById("enemy-hp-text").innerText = `HP: ${enemy.hp} / ${enemy.maxHp}`;
            document.getElementById("enemy-hp-fill").style.width = `${(enemy.hp / enemy.maxHp) * 100}%`;

            for(let i = 0; i < 3; i++) {
                let btn = document.getElementById(`btn-skill-${i}`);
                let skill = player.skills[i];
                if(skill.currentCt > 0) {
                    btn.innerText = `${skill.name} (ã‚ã¨${skill.currentCt}ã‚¿ãƒ¼ãƒ³)`;
                    btn.disabled = true;
                } else {
                    btn.innerText = skill.name;
                    if(player.hp > 0 && enemy.hp > 0) btn.disabled = false;
                }
            }
        }

        // 2. æ”»æ’ƒã®åˆ¤å®šå‡¦ç†ï¼ˆå‘½ä¸­ãƒ»å›é¿ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚’ã™ã¹ã¦è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼‰
        function performAttack(attacker, defender, skill) {
            // â‘  å‘½ä¸­åˆ¤å®š (æŠ€ã®å‘½ä¸­ç‡ - ç›¸æ‰‹ã®å›é¿ç‡)
            let hitChance = skill.accuracy - defender.eva;
            if (Math.random() > hitChance) {
                return { damage: 0, isMiss: true, isCrit: false }; // å¤–ã‚ŒãŸï¼
            }

            // â‘¡ ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®— (åŸºæœ¬è¨ˆç®— Ã— ä¹±æ•° Ã— æŠ€å¨åŠ›)
            let baseDamage = attacker.atk - (defender.def / 2);
            let randomFactor = (Math.random() * 0.3) + 0.85; 
            let finalDamage = Math.floor(baseDamage * randomFactor * skill.power);
            finalDamage = Math.max(1, finalDamage);

            // â‘¢ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®š (5%ã®ç¢ºç‡ã§ãƒ€ãƒ¡ãƒ¼ã‚¸1.5å€)
            let isCrit = false;
            if (Math.random() < attacker.critRate) {
                isCrit = true;
                finalDamage = Math.floor(finalDamage * 1.5);
            }

            return { damage: finalDamage, isMiss: false, isCrit: isCrit };
        }

        // 3. ã‚¿ãƒ¼ãƒ³ã®é€²è¡Œ
        function executeTurn(skillIndex) {
            if (player.hp <= 0 || enemy.hp <= 0) return;

            let pSkill = player.skills[skillIndex];
            pSkill.currentCt = pSkill.maxCt; // CTç™ºç”Ÿ
            disableAllButtons();

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒå‡¦ç†
            let pResult = performAttack(player, enemy, pSkill);
            
            if (pResult.isMiss) {
                addLog(`â–¶ ${player.name}ã® ${pSkill.name}ï¼ <span class="miss-text">...ã—ã‹ã—é¿ã‘ã‚‰ã‚ŒãŸï¼ï¼ˆãƒŸã‚¹ï¼‰</span>`);
            } else {
                enemy.hp = Math.max(0, enemy.hp - pResult.damage);
                let critText = pResult.isCrit ? `<span class="crit-text">ä¼šå¿ƒã®ä¸€æ’ƒï¼ï¼</span> ` : "";
                addLog(`â–¶ ${player.name}ã® ${pSkill.name}ï¼ ${critText}${enemy.name}ã« ${pResult.damage} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
            }
            
            updateUI();
            
            if (enemy.hp <= 0) {
                addLog(`â­ ${enemy.name}ã®æ´—è„³ãŒè§£ã‘ã€ä»²é–“ã«åŠ ã‚ã£ãŸï¼`);
                return;
            }

            // æ•µã®åæ’ƒå‡¦ç†ï¼ˆå°‘ã—é…ã‚Œã¦ç™ºç”Ÿï¼‰
            setTimeout(() => {
                let eSkill = enemy.skills[0];
                let eResult = performAttack(enemy, player, eSkill);
                
                if (eResult.isMiss) {
                    addLog(`â–· ${enemy.name}ã® ${eSkill.name}ï¼ <span class="miss-text">...ã—ã‹ã—å¤–ã‚ŒãŸï¼ï¼ˆãƒŸã‚¹ï¼‰</span>`);
                } else {
                    player.hp = Math.max(0, player.hp - eResult.damage);
                    let critText = eResult.isCrit ? `<span class="crit-text">ç—›æ¨ã®ä¸€æ’ƒï¼ï¼</span> ` : "";
                    addLog(`â–· ${enemy.name}ã® ${eSkill.name}ï¼ ${critText}${player.name}ã« ${eResult.damage} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
                }
                
                // CTã‚’æ¸›ã‚‰ã™
                for(let i=0; i<3; i++) {
                    if(player.skills[i].currentCt > 0) player.skills[i].currentCt--;
                }

                updateUI();
                
                if (player.hp <= 0) {
                    addLog(`ğŸ’€ ${player.name}ã¯å€’ã‚ŒãŸ...ç›®ã®å‰ãŒçœŸã£æš—ã«ãªã£ãŸã€‚`);
                    disableAllButtons();
                }
            }, 800); 
        }

        function disableAllButtons() {
            for(let i = 0; i < 3; i++) {
                document.getElementById(`btn-skill-${i}`).disabled = true;
            }
        }
    </script>
</body>
</html>
